#!/usr/bin/env bash

API_BASE="https://v6.db.transport.rest"
SCRIPT_PATH="$(realpath "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
PARENT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PARENT_DIR/.env"

# Ensure .env exists
if [[ -s "$ENV_FILE" ]]; then
	read -rp "Overwrite .env file? (Y/n)" flag
	if [[ "$flag" = "n" ]]; then
		exit 0
	fi
	echo "" > "$ENV_FILE"
fi

# Resolve a stop name or ID to an ID
resolve_stop_id() {
  local input="$1"

  # ID shortcut
  if [[ "$input" =~ ^[0-9]+$ ]]; then
    echo "$input"
    return
  fi

  echo "Searching for stop: $input" >&2

  local response
  response=$(curl -sG \
    --data-urlencode "query=$input" \
    --data-urlencode "results=50" \
    --data-urlencode "type=stop" \
    "$API_BASE/locations")

  local total
  total=$(echo "$response" | jq 'length')

  if [[ "$total" -eq 0 ]]; then
    echo "‚ùå No stops found for \"$input\"" >&2
    exit 1
  fi

  mapfile -t STOP_IDS < <(echo "$response" | jq -r '.[].id')
  mapfile -t STOP_LABELS < <(
    echo "$response" | jq -r '.[] | "\(.name) ‚Äî \(.id)"'
  )

  local page=0
  local page_size=5
  local max_page=$(( (total - 1) / page_size ))

  while true; do
    # Clear screen safely
    printf "\033c" >&2

    local start=$((page * page_size))
    local end=$((start + page_size))

    {
      echo "Select a stop (results $((start + 1))‚Äì$((end < total ? end : total)) of $total)"
      echo
      for ((i=start; i<end && i<total; i++)); do
        printf "%d) %s\n" "$((i - start + 1))" "${STOP_LABELS[$i]}"
      done
      echo
      [[ "$page" -lt "$max_page" ]] && echo "n) Next page"
      [[ "$page" -gt 0 ]] && echo "p) Previous page"
      echo "q) Cancel"
      echo
    } >&2

    read -rp "Choice: " choice

    case "$choice" in
      [1-5])
        local index=$((start + choice - 1))
        if [[ "$index" -lt "$total" ]]; then
          echo "${STOP_IDS[$index]}"
          return
        fi
        ;;
      n)
        [[ "$page" -lt "$max_page" ]] && ((page++))
        ;;
      p)
        [[ "$page" -gt 0 ]] && ((page--))
        ;;
      q)
        echo "Cancelled." >&2
        exit 1
        ;;
      *)
        echo "Invalid choice." >&2
        sleep 1
        ;;
    esac
  done
}

# Write or replace key in .env
write_env() {
  local key="$1"
  local value="$2"

  if grep -q "^${key}=" "$ENV_FILE"; then
    sed -i "s|^${key}=.*|${key}=${value}|" "$ENV_FILE"
  else
    echo "${key}=${value}" >> "$ENV_FILE"
  fi
}

# ---- MAIN FLOW ----

read -rp "Enter stop name or stop ID: " STOP_INPUT
STOP_ID=$(resolve_stop_id "$STOP_INPUT")
write_env "STOP_ID" "$STOP_ID"
echo "‚úÖ STOP_ID set to $STOP_ID"

echo

read -rp "Enter direction stop name or ID (optional, press Enter to skip): " DIR_INPUT

if [[ -n "$DIR_INPUT" ]]; then
  DIRECTION_STOP_ID=$(resolve_stop_id "$DIR_INPUT")
  write_env "DIRECTION_STOP_ID" "$DIRECTION_STOP_ID"
  echo "‚úÖ DIRECTION_STOP_ID set to $DIRECTION_STOP_ID"
else
  echo "‚ÑπÔ∏è No direction stop provided"
fi

echo
echo "üìÑ Updated $ENV_FILE:"
cat "$ENV_FILE"

